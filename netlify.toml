# netlify.toml - ACTUALIZADO

[build]
  # Si ya configuras build/publish en la UI, puedes omitir estos dos.

[build.environment]
  TZ = "America/Santiago"

[functions]
  directory = "netlify/functions"
  node_bundler = "esbuild"

# üïí Scheduled Function
[functions."daily-reminders"]
schedule = "30 13 * * *"  # 14:30 CL (18:30 UTC, ajustar en verano a 17:30)

# ‚è±Ô∏è Timeout extendido para funci√≥n de IA
[functions."ai-analysis"]
timeout = 25  # 25 segundos para dar tiempo a la API de DeepSeek

# RUTAS EXISTENTES
[[redirects]]
  from = "/treatments/popular"
  to = "/.netlify/functions/popular"
  status = 200
  methods = ["GET", "OPTIONS"]

# ‚úÖ Ruta espec√≠fica para agregar sesiones (debe ir ANTES de la ruta gen√©rica)
[[redirects]]
  from = "/treatments/patient/:patientId/session"
  to = "/.netlify/functions/treatments"
  status = 200
  methods = ["POST", "OPTIONS"]

# ‚úÖ Rutas para obtener presupuestos de un paciente
[[redirects]]
  from = "/treatments/patient/:patientId/budgets"
  to = "/.netlify/functions/treatments"
  status = 200
  methods = ["GET", "OPTIONS"]

# ‚úÖ Rutas para obtener tratamientos de un presupuesto
[[redirects]]
  from = "/treatments/budget/:budgetId"
  to = "/.netlify/functions/treatments"
  status = 200
  methods = ["GET", "OPTIONS"]

[[redirects]]
  from = "/api/treatments/patient/:patientId"
  to = "/.netlify/functions/treatments"
  status = 200

[[redirects]]
  from = "/api/treatments/:treatmentId"
  to = "/.netlify/functions/treatments"
  status = 200

[[redirects]]
  from = "/api/auth/*"
  to = "/.netlify/functions/auth"
  status = 200

[[redirects]]
  from = "/patient-history/*"
  to = "/.netlify/functions/patient-history"
  status = 200
  methods = ["GET", "OPTIONS"]

[[redirects]]
  from = "/api/patients/*"
  to = "/.netlify/functions/patients/patients"
  status = 200

[[redirects]]
  from = "/api/user/*"
  to = "/.netlify/functions/user/user"
  status = 200

[[redirects]]
  from = "/api/upload"
  to = "/.netlify/functions/upload"
  status = 200

[[redirects]]
  from = "/api/appointments"
  to = "/.netlify/functions/appointments/appointments"
  status = 200
  methods = ["GET", "POST", "OPTIONS"]

[[redirects]]
  from = "/api/appointments/*"
  to = "/.netlify/functions/appointments/appointments"
  status = 200
  methods = ["GET", "PUT", "DELETE", "OPTIONS"]

[[redirects]]
  from = "/api/appointments/*/status"
  to = "/.netlify/functions/appointments/status"
  status = 200
  methods = ["PUT", "OPTIONS"]

[[redirects]]
  from = "/api/appointments/availability"
  to = "/.netlify/functions/appointments/availability"
  status = 200
  methods = ["GET", "OPTIONS"]

# SCHEDULE BLOCKS ROUTES
[[redirects]]
  from = "/schedule-blocks"
  to = "/.netlify/functions/schedule-blocks/schedule-blocks"
  status = 200
  methods = ["GET", "POST", "OPTIONS"]

[[redirects]]
  from = "/schedule-blocks/*"
  to = "/.netlify/functions/schedule-blocks/schedule-blocks"
  status = 200
  methods = ["GET", "PUT", "DELETE", "OPTIONS"]

# DOCUMENTOS ROUTES
[[redirects]]
  from = "/documents/*"
  to = "/.netlify/functions/documents/documents"
  status = 200
  methods = ["GET", "POST", "PUT", "DELETE", "OPTIONS"]

# PUBLIC BOOKING ROUTES (public appointment booking for patients) - MUST be before SPA fallback
[[redirects]]
  from = "/public-booking-info/*"
  to = "/.netlify/functions/public-booking"
  status = 200
  methods = ["GET", "OPTIONS"]

[[redirects]]
  from = "/public-booking/*"
  to = "/.netlify/functions/public-booking"
  status = 200
  methods = ["POST", "OPTIONS"]

# AI ANALYSIS ROUTES (patient clinical summary and AI assistant)
[[redirects]]
  from = "/ai-analysis/*"
  to = "/.netlify/functions/ai-analysis/ai-analysis"
  status = 200
  methods = ["POST", "OPTIONS"]

# AUDIT LOGS ROUTES (medical history audit trail)
[[redirects]]
  from = "/audit-logs/*"
  to = "/.netlify/functions/audit-logs/audit-logs"
  status = 200
  methods = ["GET", "OPTIONS"]

# BUDGETS ROUTES (existing, just moved after documents)
[[redirects]]
  from = "/budgets/revenue-treatments"
  to = "/.netlify/functions/budgets"
  status = 200
  methods = ["GET", "OPTIONS"]

[[redirects]]
  from = "/api/budgets/*"
  to = "/.netlify/functions/budgets"
  status = 200

# SPA fallback (MUST be last)
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200